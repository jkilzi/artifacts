{"version":3,"file":"generateUiSchema.esm.js","sources":["../../src/utils/generateUiSchema.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n/* eslint-disable @typescript-eslint/no-use-before-define */\n\nimport { JsonObject } from '@backstage/types';\n\nimport { UiSchema } from '@rjsf/utils';\nimport type { JSONSchema7, JSONSchema7Definition } from 'json-schema';\nimport get from 'lodash/get';\nimport set from 'lodash/set';\n\n/**\n * Extracts the uiSchema from a mixed JSON Schema that includes\n * both standard JSON Schema properties and react-json-schema-form specific\n * UI Schema properties (prefixed with 'ui:'). The function does not modify\n * the original JSON Schema.\n *\n * @param mixedSchema - The JSON Schema that contains both standard and UI Schema properties.\n * @returns An object representing the uiSchema.\n */\n\nconst getSchemaDefinition = (ref: string, rootSchema: JSONSchema7) => {\n  const path = ref.replace(/^#\\//, '').replace(/\\//g, '.');\n  return get(rootSchema, path);\n};\n\nconst getStringAfterDot = (input: string) =>\n  input.startsWith('.') ? input.slice(1) : input;\n\nfunction replaceSparseArrayElementsdWithEmptyObject(value: any): any {\n  /* handle cases where ui: properties exists for some of the itmes in the array, for example: \n    {\n      \"selectedItem\": {\n      \"anyOf\": [\n        ,\n        ,\n        {\n          \"ui:widget\": \"color\",\n        },\n      ],\n    }\n    the function will return \n    {\n      \"selectedItem\": {\n      \"anyOf\": [\n        {},\n        {},\n        {\n          \"ui:widget\": \"color\",\n        },\n      ],\n    }\n  */\n  if (Array.isArray(value)) {\n    return [...value].map(item => {\n      return item ? replaceSparseArrayElementsdWithEmptyObject(item) : {};\n    });\n  } else if (value && typeof value === 'object') {\n    return Object.keys(value).reduce(\n      (acc, key) => {\n        acc[key] = replaceSparseArrayElementsdWithEmptyObject(value[key]);\n        return acc;\n      },\n      {} as Record<string, any>,\n    );\n  }\n  return value;\n}\n\nfunction extractUiSchema(mixedSchema: JSONSchema7): UiSchema<JsonObject> {\n  const rootSchema = mixedSchema;\n  const result = {};\n\n  const processObjectProperties = (\n    properties: {\n      [key: string]: JSONSchema7Definition;\n    },\n    path: string,\n  ) => {\n    for (const [key, value] of Object.entries(properties)) {\n      // eslint-disable-next-line @typescript-eslint/no-use-before-define\n      processObject(value, `${path}.${key}`);\n    }\n  };\n\n  const processObject = (curSchema: JSONSchema7Definition, path: string) => {\n    if (typeof curSchema === 'boolean') {\n      return;\n    }\n    if (curSchema.$ref) {\n      processObject(getSchemaDefinition(curSchema.$ref, rootSchema), path);\n    } else if (curSchema.properties) {\n      processObjectProperties(curSchema.properties, path);\n    } else if (curSchema.items) {\n      processArraySchema(curSchema, path);\n    } else {\n      processLeafSchema(curSchema, path);\n    }\n    processComposedSchema(curSchema, path);\n  };\n\n  const processLeafSchema = (\n    leafSchema: JSONSchema7Definition,\n    path: string,\n  ) => {\n    for (const [subSchemaKey, value] of Object.entries(leafSchema)) {\n      if (subSchemaKey.startsWith('ui:')) {\n        set(result, getStringAfterDot(`${path}.${subSchemaKey}`), value);\n      }\n    }\n  };\n\n  const processArrayItems = (items: JSONSchema7Definition[], path: string) => {\n    for (let i = 0; i < items.length; ++i) {\n      processObject(items[i], `${path}[${i}]`);\n    }\n  };\n\n  const processArraySchema = (schema: JSONSchema7, path: string) => {\n    if (Array.isArray(schema.items)) {\n      processArrayItems(schema.items, `${path}.items`);\n    } else if (typeof schema.items === 'object') {\n      processObject(schema.items, `${path}.items`);\n    }\n    if (schema.additionalItems && typeof schema.additionalItems === 'object') {\n      processObject(schema.additionalItems, `${path}.additinalItems`);\n    }\n  };\n\n  const processComposedSchema = (curSchema: JSONSchema7, path: string) => {\n    if (curSchema.anyOf) {\n      processArrayItems(curSchema.anyOf, `${path}.anyOf`);\n    } else if (curSchema.oneOf) {\n      processArrayItems(curSchema.oneOf, `${path}.oneOf`);\n    } else if (curSchema.allOf) {\n      processArrayItems(curSchema.allOf, `${path}.allOf`);\n    } else if (curSchema.then) {\n      processObject(curSchema.then, `${path}`);\n      if (curSchema.else) {\n        processObject(curSchema.else, `${path}`);\n      }\n    }\n  };\n\n  processObject(mixedSchema, '');\n  return replaceSparseArrayElementsdWithEmptyObject(result);\n}\n\nconst addReadonly = (\n  data: JsonObject,\n  uiSchema: UiSchema<JsonObject>,\n  isMultiStep: boolean,\n) => {\n  // make inputs that came from assessment instance variables readonly\n  if (!isMultiStep) {\n    for (const key of Object.keys(data)) {\n      uiSchema[key] = {\n        ...uiSchema[key],\n        'ui:readonly': true,\n      };\n    }\n    return;\n  }\n  for (const [stepKey, stepValue] of Object.entries(data)) {\n    uiSchema[stepKey] = {\n      ...uiSchema[stepKey],\n    };\n    for (const key of Object.keys(stepValue as JsonObject)) {\n      uiSchema[stepKey][key] = {\n        ...uiSchema[stepKey][key],\n        'ui:readonly': true,\n      };\n    }\n  }\n};\n\nconst addFocusOnFirstElement = (\n  schema: JSONSchema7,\n  uiSchema: UiSchema<JsonObject>,\n  isMultiStep: boolean,\n) => {\n  if (!schema.properties) {\n    return;\n  }\n  if (!isMultiStep) {\n    const firstKey = Object.keys(schema.properties)[0];\n    uiSchema[firstKey] = {\n      ...uiSchema[firstKey],\n      'ui:autofocus': true,\n    };\n  }\n  for (const [stepKey, subSchema] of Object.entries(schema.properties)) {\n    if (typeof subSchema !== 'object') {\n      return;\n    }\n    const _subSchema = subSchema.$ref\n      ? getSchemaDefinition(subSchema.$ref, schema)\n      : subSchema;\n    if (!_subSchema.properties) {\n      return;\n    }\n    const subSchemaFirstKey = Object.keys(_subSchema.properties)[0];\n    uiSchema[stepKey] = {\n      ...uiSchema[stepKey],\n      [subSchemaFirstKey]: {\n        ...uiSchema[stepKey]?.[subSchemaFirstKey],\n        'ui:autofocus': true,\n      },\n    };\n  }\n};\n\nconst generateUiSchema = (\n  schema: JSONSchema7,\n  isMultiStep: boolean,\n  readonlyData?: JsonObject,\n): UiSchema<JsonObject> => {\n  const uiSchema = extractUiSchema(schema);\n  if (readonlyData) {\n    addReadonly(readonlyData, uiSchema, isMultiStep);\n  }\n  addFocusOnFirstElement(schema, uiSchema, isMultiStep);\n  return uiSchema;\n};\n\nexport default generateUiSchema;\n"],"names":[],"mappings":"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"}