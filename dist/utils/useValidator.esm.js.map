{"version":3,"file":"useValidator.esm.js","sources":["../../src/utils/useValidator.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { JsonObject } from '@backstage/types';\n\nimport {\n  createErrorHandler,\n  CustomValidator,\n  ErrorSchema,\n  RJSFValidationError,\n  unwrapErrorHandler,\n  ValidationData,\n  validationDataMerge,\n  ValidatorType,\n} from '@rjsf/utils';\nimport validatorAjv from '@rjsf/validator-ajv8';\nimport _validator from '@rjsf/validator-ajv8';\nimport type { JSONSchema7 } from 'json-schema';\n\nimport { useStepperContext } from './StepperContext';\n\n// add the activeStep to the validator to force rjsf form to rerender when activeStep changes. This doesn't happen because it assumes function are equal.\n// see https://github.com/rjsf-team/react-jsonschema-form/blob/v5.18.5/packages/utils/src/deepEquals.ts#L12\n\nexport type ValidatorTypeForceRender = ValidatorType<\n  JsonObject,\n  JSONSchema7\n> & {\n  activeStep: number;\n};\n\nconst useValidator = (isMultiStepSchema: boolean) => {\n  const { activeStep } = useStepperContext();\n  const validator: ValidatorTypeForceRender = {\n    activeStep,\n    validateFormData: (\n      formData: JsonObject,\n      _schema: JSONSchema7,\n      customValidate: CustomValidator<JsonObject, JSONSchema7, any>,\n    ): ValidationData<JsonObject> => {\n      let validationData = validatorAjv.validateFormData(formData, _schema);\n\n      if (customValidate) {\n        const errorHandler = customValidate(\n          formData,\n          createErrorHandler<JsonObject>(formData),\n        );\n        const userErrorSchema = unwrapErrorHandler<JsonObject>(errorHandler);\n        validationData = validationDataMerge<JsonObject>(\n          validationData,\n          userErrorSchema,\n        );\n      }\n\n      if (!isMultiStepSchema) {\n        return validationData;\n      }\n\n      const activeKey = Object.keys(_schema.properties || {})[activeStep];\n      return {\n        errors: validationData.errors.filter(err =>\n          err.property?.startsWith(`.${activeKey}.`),\n        ),\n        errorSchema: validationData.errorSchema[activeKey] || {},\n      };\n    },\n\n    toErrorList: (\n      errorSchema?: ErrorSchema<any>,\n      fieldPath?: string[],\n    ): RJSFValidationError[] => {\n      return validatorAjv.toErrorList(errorSchema, fieldPath);\n    },\n\n    isValid: (\n      _schema: JSONSchema7,\n      formData: JsonObject | undefined,\n      rootSchema: JSONSchema7,\n    ) => {\n      return validatorAjv.isValid(_schema, formData, rootSchema);\n    },\n\n    rawValidation: (_schema: JSONSchema7, formData?: JsonObject) =>\n      validatorAjv.rawValidation(_schema, formData),\n  };\n\n  return validator;\n};\n\nexport default useValidator;\n"],"names":[],"mappings":";;;;AA2CM,MAAA,YAAA,GAAe,CAAC,iBAA+B,KAAA;AACnD,EAAM,MAAA,EAAE,UAAW,EAAA,GAAI,iBAAkB,EAAA,CAAA;AACzC,EAAA,MAAM,SAAsC,GAAA;AAAA,IAC1C,UAAA;AAAA,IACA,gBAAkB,EAAA,CAChB,QACA,EAAA,OAAA,EACA,cAC+B,KAAA;AAC/B,MAAA,IAAI,cAAiB,GAAA,YAAA,CAAa,gBAAiB,CAAA,QAAA,EAAU,OAAO,CAAA,CAAA;AAEpE,MAAA,IAAI,cAAgB,EAAA;AAClB,QAAA,MAAM,YAAe,GAAA,cAAA;AAAA,UACnB,QAAA;AAAA,UACA,mBAA+B,QAAQ,CAAA;AAAA,SACzC,CAAA;AACA,QAAM,MAAA,eAAA,GAAkB,mBAA+B,YAAY,CAAA,CAAA;AACnE,QAAiB,cAAA,GAAA,mBAAA;AAAA,UACf,cAAA;AAAA,UACA,eAAA;AAAA,SACF,CAAA;AAAA,OACF;AAEA,MAAA,IAAI,CAAC,iBAAmB,EAAA;AACtB,QAAO,OAAA,cAAA,CAAA;AAAA,OACT;AAEA,MAAM,MAAA,SAAA,GAAY,OAAO,IAAK,CAAA,OAAA,CAAQ,cAAc,EAAE,EAAE,UAAU,CAAA,CAAA;AAClE,MAAO,OAAA;AAAA,QACL,MAAA,EAAQ,eAAe,MAAO,CAAA,MAAA;AAAA,UAAO,SACnC,GAAI,CAAA,QAAA,EAAU,UAAW,CAAA,CAAA,CAAA,EAAI,SAAS,CAAG,CAAA,CAAA,CAAA;AAAA,SAC3C;AAAA,QACA,WAAa,EAAA,cAAA,CAAe,WAAY,CAAA,SAAS,KAAK,EAAC;AAAA,OACzD,CAAA;AAAA,KACF;AAAA,IAEA,WAAA,EAAa,CACX,WAAA,EACA,SAC0B,KAAA;AAC1B,MAAO,OAAA,YAAA,CAAa,WAAY,CAAA,WAAA,EAAa,SAAS,CAAA,CAAA;AAAA,KACxD;AAAA,IAEA,OAAS,EAAA,CACP,OACA,EAAA,QAAA,EACA,UACG,KAAA;AACH,MAAA,OAAO,YAAa,CAAA,OAAA,CAAQ,OAAS,EAAA,QAAA,EAAU,UAAU,CAAA,CAAA;AAAA,KAC3D;AAAA,IAEA,eAAe,CAAC,OAAA,EAAsB,aACpC,YAAa,CAAA,aAAA,CAAc,SAAS,QAAQ,CAAA;AAAA,GAChD,CAAA;AAEA,EAAO,OAAA,SAAA,CAAA;AACT;;;;"}