{"version":3,"file":"OrchestratorFormWrapper.esm.js","sources":["../../src/components/OrchestratorFormWrapper.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\n\nimport { ErrorPanel } from '@backstage/core-components';\nimport { useApiHolder } from '@backstage/core-plugin-api';\nimport { JsonObject } from '@backstage/types';\n\nimport { Grid } from '@material-ui/core';\nimport { withTheme } from '@rjsf/core';\nimport { Theme as MuiTheme } from '@rjsf/material-ui';\nimport { ErrorSchema, UiSchema } from '@rjsf/utils';\nimport type { JSONSchema7 } from 'json-schema';\nimport omit from 'lodash/omit';\n\nimport {\n  FormDecoratorProps,\n  orchestratorFormApiRef,\n} from '@red-hat-developer-hub/backstage-plugin-orchestrator-form-api';\n\nimport { defaultFormExtensionsApi } from '../DefaultFormApi';\nimport { useStepperContext } from '../utils/StepperContext';\nimport useValidator from '../utils/useValidator';\nimport StepperObjectField from './StepperObjectField';\n\nconst MuiForm = withTheme<JsonObject, JSONSchema7>(MuiTheme);\n\ntype OrchestratorFormWrapperProps = {\n  schema: JSONSchema7;\n  numStepsInMultiStepSchema?: number;\n  children: React.ReactNode;\n  onSubmit: (formData: JsonObject) => void;\n  uiSchema: UiSchema<JsonObject, JSONSchema7>;\n  initialFormData?: JsonObject;\n};\n\nconst WrapperFormPropsContext =\n  React.createContext<OrchestratorFormWrapperProps | null>(null);\n\nconst useWrapperFormPropsContext = (): OrchestratorFormWrapperProps => {\n  const context = React.useContext(WrapperFormPropsContext);\n  if (context === null) {\n    throw new Error('OrchestratorFormWrapperProps not provided');\n  }\n  return context;\n};\n\nconst FormComponent = (decoratorProps: FormDecoratorProps) => {\n  const props = useWrapperFormPropsContext();\n  const {\n    numStepsInMultiStepSchema,\n    uiSchema,\n    schema,\n    onSubmit: _onSubmit,\n    initialFormData,\n    children,\n  } = props;\n  const [extraErrors, setExtraErrors] = React.useState<\n    ErrorSchema<JsonObject> | undefined\n  >();\n  // make this form a controlled component so state will remain when moving between steps. see https://rjsf-team.github.io/react-jsonschema-form/docs/quickstart#controlled-component\n  const [formData, setFormData] = React.useState<JsonObject>(\n    initialFormData || {},\n  );\n  const isMultiStep = numStepsInMultiStepSchema !== undefined;\n  const { handleNext, activeStep, handleValidateStarted, handleValidateEnded } =\n    useStepperContext();\n  const [validationError, setValidationError] = React.useState<\n    Error | undefined\n  >();\n  const validator = useValidator(isMultiStep);\n  const getActiveKey = () => {\n    if (!isMultiStep) {\n      return undefined;\n    }\n    return Object.keys(schema.properties || {})[activeStep];\n  };\n\n  const onSubmit = async (_formData: JsonObject) => {\n    setExtraErrors(undefined);\n    let _extraErrors: ErrorSchema<JsonObject> | undefined = undefined;\n    let _validationError: Error | undefined = undefined;\n    if (decoratorProps.getExtraErrors) {\n      try {\n        handleValidateStarted();\n        _extraErrors = await decoratorProps.getExtraErrors(formData);\n        const activeKey = getActiveKey();\n        setExtraErrors(\n          activeKey && _extraErrors?.[activeKey]\n            ? (_extraErrors[activeKey] as ErrorSchema<JsonObject>)\n            : _extraErrors,\n        );\n      } catch (err) {\n        _validationError = err as Error;\n      } finally {\n        handleValidateEnded();\n      }\n    }\n    setValidationError(_validationError);\n    if (\n      (!_extraErrors || Object.keys(_extraErrors).length === 0) &&\n      !_validationError &&\n      activeStep < (numStepsInMultiStepSchema || 1)\n    ) {\n      _onSubmit(_formData);\n      handleNext();\n    }\n  };\n\n  return (\n    <Grid container spacing={2} direction=\"column\" wrap=\"nowrap\">\n      {validationError && (\n        <Grid item>\n          <ErrorPanel error={validationError} />\n        </Grid>\n      )}\n      <Grid item>\n        <MuiForm\n          {...omit(decoratorProps, 'getExtraErrors')}\n          fields={isMultiStep ? { ObjectField: StepperObjectField } : {}}\n          uiSchema={uiSchema}\n          validator={validator}\n          schema={schema}\n          formData={decoratorProps.formData || formData}\n          noHtml5Validate\n          extraErrors={extraErrors}\n          onSubmit={e => onSubmit(e.formData || {})}\n          onChange={e => {\n            setFormData(e.formData || {});\n            if (decoratorProps.onChange) {\n              decoratorProps.onChange(e);\n            }\n          }}\n        >\n          {children}\n        </MuiForm>\n      </Grid>\n    </Grid>\n  );\n};\n\nconst OrchestratorFormWrapper = ({\n  schema,\n  uiSchema,\n  initialFormData,\n  ...props\n}: OrchestratorFormWrapperProps) => {\n  const formApi =\n    useApiHolder().get(orchestratorFormApiRef) || defaultFormExtensionsApi;\n  const NewComponent = React.useMemo(() => {\n    const formDecorator = formApi.getFormDecorator(\n      schema,\n      uiSchema,\n      initialFormData,\n    );\n    return formDecorator(FormComponent);\n  }, [schema, uiSchema, formApi, initialFormData]);\n  return (\n    <WrapperFormPropsContext.Provider\n      value={{ schema, uiSchema, initialFormData, ...props }}\n    >\n      <NewComponent />\n    </WrapperFormPropsContext.Provider>\n  );\n};\n\nexport default OrchestratorFormWrapper;\n"],"names":["MuiTheme"],"mappings":"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"}