{"version":3,"file":"OrchestratorForm.esm.js","sources":["../../src/components/OrchestratorForm.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { Fragment } from 'react';\n\nimport { JsonObject } from '@backstage/types';\n\nimport { UiSchema } from '@rjsf/utils';\nimport type { JSONSchema7 } from 'json-schema';\n\nimport generateUiSchema from '../utils/generateUiSchema';\nimport { StepperContextProvider } from '../utils/StepperContext';\nimport OrchestratorFormStepper, {\n  OrchestratorFormStep,\n  OrchestratorFormToolbar,\n} from './OrchestratorFormStepper';\nimport OrchestratorFormWrapper from './OrchestratorFormWrapper';\nimport ReviewStep from './ReviewStep';\n\nconst getNumSteps = (schema: JSONSchema7): number | undefined => {\n  if (schema.type !== 'object' || !schema.properties) return undefined;\n  const isMultiStep = Object.values(schema.properties).every(\n    prop => (prop as JSONSchema7).type === 'object',\n  );\n  return isMultiStep ? Object.keys(schema.properties).length : undefined;\n};\n\nconst SingleStepForm = ({\n  schema,\n  initialFormData,\n  onSubmit,\n  uiSchema,\n}: {\n  schema: JSONSchema7;\n  initialFormData?: JsonObject;\n  onSubmit: (formData: JsonObject) => void;\n  uiSchema: UiSchema<JsonObject>;\n}) => {\n  const [_initialFormData, setInitialFormData] = React.useState<\n    JsonObject | undefined\n  >(initialFormData);\n\n  const _onSubmit = React.useCallback(\n    (formData: JsonObject) => {\n      // Since the review step is outside of the MuiForm component in SingleStepForm, we need to load the current values when navigating back.\n      setInitialFormData(formData);\n      onSubmit(formData);\n    },\n    [onSubmit, setInitialFormData],\n  );\n\n  const steps = React.useMemo<OrchestratorFormStep[]>(() => {\n    return [\n      {\n        title: schema.title || 'Inputs',\n        key: 'schema',\n        content: (\n          <OrchestratorFormWrapper\n            schema={{ ...schema, title: '' }}\n            initialFormData={_initialFormData}\n            onSubmit={_onSubmit}\n            uiSchema={uiSchema}\n          >\n            <OrchestratorFormToolbar />\n          </OrchestratorFormWrapper>\n        ),\n      },\n    ];\n  }, [schema, _initialFormData, uiSchema, _onSubmit]);\n  return <OrchestratorFormStepper steps={steps} />;\n};\n\n/**\n * @public\n * OrchestratorForm component properties\n */\nexport type OrchestratorFormProps = {\n  schema: JSONSchema7;\n  isExecuting: boolean;\n  handleExecute: (parameters: JsonObject) => Promise<void>;\n  data?: JsonObject;\n  isDataReadonly?: boolean;\n};\n\n/**\n * @public\n * The component contains the react-json-schema-form and serves as an extensible form. It allows loading a custom plugin decorator to override the default react-json-schema-form properties.\n */\nconst OrchestratorForm = ({\n  schema,\n  handleExecute,\n  isExecuting,\n  data,\n  isDataReadonly,\n}: OrchestratorFormProps) => {\n  const [formData, setFormData] = React.useState<JsonObject>(data || {});\n  const numStepsInMultiStepSchema = React.useMemo(\n    () => getNumSteps(schema),\n    [schema],\n  );\n  const isMultiStep = numStepsInMultiStepSchema !== undefined;\n\n  const _handleExecute = React.useCallback(() => {\n    handleExecute(formData || {});\n  }, [formData, handleExecute]);\n\n  const onSubmit = React.useCallback(\n    (_formData: JsonObject) => {\n      setFormData(_formData);\n    },\n    [setFormData],\n  );\n\n  const uiSchema = React.useMemo<UiSchema<JsonObject>>(() => {\n    return generateUiSchema(\n      schema,\n      isMultiStep,\n      isDataReadonly ? data : undefined,\n    );\n  }, [schema, isMultiStep, isDataReadonly, data]);\n\n  const reviewStep = React.useMemo(\n    () => (\n      <ReviewStep\n        data={formData || {}}\n        schema={schema}\n        busy={isExecuting}\n        handleExecute={_handleExecute}\n      />\n    ),\n    [formData, schema, isExecuting, _handleExecute],\n  );\n\n  return (\n    <StepperContextProvider reviewStep={reviewStep}>\n      {isMultiStep ? (\n        <OrchestratorFormWrapper\n          schema={schema}\n          numStepsInMultiStepSchema={numStepsInMultiStepSchema}\n          onSubmit={onSubmit}\n          uiSchema={uiSchema}\n          initialFormData={data}\n        >\n          <Fragment />\n        </OrchestratorFormWrapper> // it is required to pass the fragment so rjsf won't generate a Submit button\n      ) : (\n        <SingleStepForm\n          schema={schema}\n          onSubmit={onSubmit}\n          initialFormData={data}\n          uiSchema={uiSchema}\n        />\n      )}\n    </StepperContextProvider>\n  );\n};\n\nexport default OrchestratorForm;\n"],"names":[],"mappings":"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"}